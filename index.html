<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance de Vendas por Loja</title>
    <!-- Inclui o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inclui a biblioteca Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Inclui o plugin Datalabels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- Fonte Inter do Google Fonts para garantir renderização correta -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f1f5f9; /* Slate 100 - Fundo corporativo claro */
        }
        .chart-container {
            position: relative;
            height: 650px; /* Altura aumentada para expandir o campo de visão */
            width: 100%;
        }
        /* Loader minimalista */
        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid #e2e8f0;
            border-bottom-color: #3b82f6;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Animações do Modal */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 300ms ease-out, transform 300ms ease-out;
        }
        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }
        .modal-exit-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 200ms ease-in, transform 200ms ease-in;
        }
    </style>
</head>
<body class="text-slate-800 antialiased p-4 md:p-8">

    <!-- Header Principal -->
    <div class="max-w-7xl mx-auto mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-slate-900 tracking-tight">
                Dashboard de Vendas
            </h1>
            <p class="text-slate-500 text-sm mt-1">
                Rede Mi Place • Acompanhamento Mensal
            </p>
        </div>
        <div class="mt-4 md:mt-0">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-white text-slate-600 border border-slate-200 shadow-sm">
                <span class="w-2 h-2 rounded-full bg-emerald-500 mr-2"></span>
                Atualizado em tempo real
            </span>
        </div>
    </div>

    <!-- Container Principal (Card Branco) -->
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden relative">
        
        <!-- KPIs / Cards de Resumo -->
        <div class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-100 border-b border-slate-100">
            <!-- Card 1 -->
            <div class="p-6 flex items-start space-x-4">
                <div class="p-3 rounded-lg bg-blue-50 text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">Total de Vendas Acumulado</p>
                    <p id="totalSales" class="text-3xl font-bold text-slate-900 mt-1">--</p>
                    <p class="text-xs text-slate-400 mt-1">Período completo</p>
                </div>
            </div>

            <!-- Card 2 -->
            <div class="p-6 flex items-start space-x-4">
                <div class="p-3 rounded-lg bg-emerald-50 text-emerald-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">Média Mensal da Rede</p>
                    <p id="averageSales" class="text-3xl font-bold text-slate-900 mt-1">--</p>
                    <p class="text-xs text-slate-400 mt-1">Vendas / Mês</p>
                </div>
            </div>
        </div>

        <!-- Área do Gráfico -->
        <div class="p-6 md:p-8 relative">
            <!-- Loading -->
            <div id="loadingIndicator" class="flex flex-col justify-center items-center h-80">
                <span class="loader mb-4"></span>
                <p class="text-slate-500 text-sm font-medium">Processando dados...</p>
            </div>

            <!-- Gráfico -->
            <div id="chartContainer" class="chart-container hidden">
                <canvas id="salesChart"></canvas>
            </div>

            <!-- Erro -->
            <div id="errorMessage" class="hidden p-4 mb-4 text-sm text-red-700 bg-red-50 rounded-lg border border-red-200" role="alert">
                <span class="font-medium">Erro ao carregar dados:</span> <span id="errorText"></span>
            </div>
        </div>
        
        <!-- Footer do Card -->
        <div class="bg-slate-50 px-6 py-4 border-t border-slate-200 flex justify-between items-center text-xs text-slate-500">
            <span>Dados de performance interna</span>
            <span>Mi Place Analytics</span>
        </div>
    </div>

    <!-- MODAL DE DETALHES -->
    <div id="detailModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Backdrop (Fundo Escurecido) -->
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity opacity-0" id="modalBackdrop"></div>

        <!-- Wrapper Centralizador (Capturamos o clique aqui também) -->
        <div id="modalWrapper" class="fixed inset-0 z-10 w-screen overflow-y-auto flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <!-- Painel Branco do Modal -->
            <div id="modalPanel" class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg modal-enter opacity-0 scale-95">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-8">
                    <div class="sm:flex sm:items-start sm:justify-center">
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-center w-full">
                            <!-- Conteúdo Dinâmico -->
                            <h3 class="text-base font-semibold leading-6 text-slate-400 uppercase tracking-widest" id="modalStoreName">LOJA</h3>
                            <div class="mt-4">
                                <p class="text-sm text-slate-500 mb-1" id="modalDateLabel">Mês/Ano</p>
                                <p class="text-6xl font-bold tracking-tighter" id="modalValueDisplay">0</p>
                                <p class="text-xs font-medium text-slate-400 mt-2">Vendas Realizadas</p>
                            </div>
                            
                            <!-- Container de Feedback -->
                            <div id="modalFeedbackContainer" class="mt-6 border-t border-slate-100 pt-4 text-left hidden">
                                <div id="modalFeedbackContent" class="text-base text-slate-600 space-y-4 bg-slate-50 p-5 rounded-lg leading-relaxed">
                                    <!-- Feedback Inserido via JS -->
                                </div>
                            </div>
                            
                            <p class="text-[10px] text-slate-400 mt-6 italic">Clique fora desta janela para fechar</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // Variáveis globais
        let salesChartInstance = null;
        let allValidData = []; 
        let chartLabels = [];

        // TEXTOS DE FEEDBACK
        const DOM_PEDRO_TEXT = `
            <p class="font-bold text-slate-900 mb-2 text-lg">Mi Place Dom Pedro (Meta: 135 | Realizado: 118)</p>
            <div class="space-y-3">
                <p class="text-base"><strong>Status:</strong> <span class="text-red-600 font-bold">Não Atingiu a Meta</span></p>
                <p class="text-base"><strong>Evolução (Jan &rarr; Fev):</strong> 151 &rarr; 118 (-21,8% de retração)</p>
                <div class="mt-4 text-slate-600 text-base italic border-l-4 border-red-300 pl-4 py-1 leading-relaxed">
                    <strong>Feedback:</strong><br/>
                    A unidade vinha de um dezembro excepcional (151 vendas, superando a meta), mas sofreu uma desaceleração considerável em janeiro. Embora ainda mantenha o maior volume absoluto da rede, a perda de 33 vendas de um mês para o outro indica que a loja não conseguiu sustentar o fluxo pós-férias. Vamos manter o foco neste mês de Fevereiro equipe!
                </div>
            </div>
        `;
        const KASSOUF_TEXT = `
            <p class="font-bold text-slate-900 mb-2 text-lg">Mi Place Kassouf (Meta: 65 | Realizado: 66)</p>
            <div class="space-y-3">
                <p class="text-base"><strong>Status:</strong> <span class="text-emerald-600 font-bold">Meta Atingida</span> (Única loja a atingir o objetivo)</p>
                <p class="text-base"><strong>Evolução (Jan &rarr; Fev):</strong> 46 &rarr; 66 (+43% de crescimento)</p>
                <div class="mt-4 text-slate-600 text-base italic border-l-4 border-emerald-300 pl-4 py-1 leading-relaxed">
                    <strong>Feedback:</strong><br/>
                    A unidade é o destaque positivo do mês. Ao contrário do restante da rede, a Kassouf reverteu o resultado ruim de dezembro 2025 (46 vendas) e acelerou fortemente em janeiro, superando a barreira das 65 unidades. Demonstrou excelente capacidade de recuperação a curto prazo. Parabéns Equipe!
                </div>
            </div>
        `;
        const REALME_TEXT = `
            <p class="font-bold text-slate-900 mb-2 text-lg">Mi Place Realme (Meta: 65 | Realizado: 55)</p>
            <div class="space-y-3">
                <p class="text-base"><strong>Status:</strong> <span class="text-red-600 font-bold">Não Atingiu a Meta</span></p>
                <p class="text-base"><strong>Evolução (Jan &rarr; Fev):</strong> 55 &rarr; 55 (Estagnado)</p>
                <div class="mt-4 text-slate-600 text-base italic border-l-4 border-red-300 pl-4 py-1 leading-relaxed">
                    <strong>Feedback:</strong><br/>
                    A unidade mostra estagnação em um patamar satisfatório. Não houve piora (como na XV ou Premium), mas também não houve reação. Esse resultado consolida uma tendência de média performance que precisa ser revertida em março, pois sabemos da capacidade da equipe. Isso mostra que a equipe está pronta para decolar nos próximos meses.
                </div>
            </div>
        `;
        const PREMIUM_TEXT = `
            <p class="font-bold text-slate-900 mb-2 text-lg">Mi Place Premium (Meta: 65 | Realizado: 41)</p>
            <div class="space-y-3">
                <p class="text-base"><strong>Status:</strong> <span class="text-red-600 font-bold">Não Atingiu a Meta</span></p>
                <p class="text-base"><strong>Evolução (Jan &rarr; Fev):</strong> 67 &rarr; 41 (-38,8% de retração)</p>
                <div class="mt-4 text-slate-600 text-base italic border-l-4 border-red-300 pl-4 py-1 leading-relaxed">
                    <strong>Feedback:</strong><br/>
                    A unidade apresentou a oscilação mais negativa da rede. Saiu de um status de "Meta Batida" em dezembro 2025 (67 vendas) para um resultado muito abaixo do esperado em janeiro. Essa volatilidade alta prejudica a previsibilidade de receita da loja. Vamos trabalhar para se manter na meta como sempre foi feito!
                </div>
            </div>
        `;
        const XV_TEXT = `
            <p class="font-bold text-slate-900 mb-2 text-lg">Mi Place XV (Meta: 65 | Realizado: 35)</p>
            <div class="space-y-3">
                <p class="text-base"><strong>Status:</strong> <span class="text-red-600 font-bold">Crítico</span></p>
                <p class="text-base"><strong>Evolução (Jan &rarr; Fev):</strong> 56 &rarr; 35 (-37,5% de retração)</p>
                <div class="mt-4 text-slate-600 text-base italic border-l-4 border-red-300 pl-4 py-1 leading-relaxed">
                    <strong>Feedback:</strong><br/>
                    Situação alarmante. Em dezembro, a loja estava próxima da meta (56), mas em janeiro o desempenho colapsou para quase metade do objetivo (35). É o pior resultado da unidade em todo o histórico recente, exigindo diagnóstico imediato. É hora de seguir as recomendaçõe da Jack para reverter o resultado e mudar esse cenário!
                </div>
            </div>
        `;

        const FEEDBACK_DATA = {
            'DOM PEDRO-Fev/26': DOM_PEDRO_TEXT,
            'KASSOUF-Fev/26': KASSOUF_TEXT,
            'REALME-Fev/26': REALME_TEXT,
            'PREMIUM-Fev/26': PREMIUM_TEXT,
            'XV-Fev/26': XV_TEXT,
            'DOM PEDRO-Jan/26': DOM_PEDRO_TEXT,
            'KASSOUF-Jan/26': KASSOUF_TEXT,
            'REALME-Jan/26': REALME_TEXT,
            'PREMIUM-Jan/26': PREMIUM_TEXT,
            'XV-Jan/26': XV_TEXT
        };

        // Elementos do Modal
        const modal = document.getElementById('detailModal');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const modalWrapper = document.getElementById('modalWrapper');
        const modalPanel = document.getElementById('modalPanel');
        const modalStoreName = document.getElementById('modalStoreName');
        const modalDateLabel = document.getElementById('modalDateLabel');
        const modalValueDisplay = document.getElementById('modalValueDisplay');
        const modalFeedbackContainer = document.getElementById('modalFeedbackContainer');
        const modalFeedbackContent = document.getElementById('modalFeedbackContent');

        // Funções do Modal
        function openModal(store, date, value, color) {
            modalStoreName.textContent = store;
            modalStoreName.style.color = color;
            modalDateLabel.textContent = date;
            modalValueDisplay.textContent = formatNumber(value);
            modalValueDisplay.style.color = color;

            const feedbackKey = `${store}-${date}`;
            const feedbackHTML = FEEDBACK_DATA[feedbackKey];

            if (feedbackHTML) {
                modalFeedbackContent.innerHTML = feedbackHTML;
                modalFeedbackContainer.classList.remove('hidden');
            } else {
                modalFeedbackContainer.classList.add('hidden');
                modalFeedbackContent.innerHTML = '';
            }

            modal.classList.remove('hidden');
            
            setTimeout(() => {
                modalBackdrop.classList.remove('opacity-0');
                modalPanel.classList.remove('opacity-0', 'scale-95');
                modalPanel.classList.add('opacity-100', 'scale-100');
            }, 10);
        }

        function closeModal() {
            modalBackdrop.classList.add('opacity-0');
            modalPanel.classList.remove('opacity-100', 'scale-100');
            modalPanel.classList.add('opacity-0', 'scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // Lógica de Fechamento corrigida:
        // Clicar no wrapper (área fora do modalPanel) fecha o modal
        modalWrapper.addEventListener('click', (e) => {
            // Se o alvo do clique for o próprio wrapper (e não o painel branco interno)
            if (e.target === modalWrapper) {
                closeModal();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });

        // --- PLUGIN: LINHAS DE META ---
        const targetLinesPlugin = {
            id: 'targetLines',
            beforeDraw: (chart) => {
                const { ctx, chartArea: { top, bottom, left, right }, scales: { y } } = chart;
                const targetLines = chart.options.plugins.targetLines?.lines || [];

                if (targetLines.length === 0) return;

                ctx.save();
                targetLines.forEach(line => {
                    const yPosition = y.getPixelForValue(line.value);
                    ctx.strokeStyle = line.color || '#94a3b8';
                    ctx.lineWidth = line.width || 1;
                    ctx.setLineDash(line.dash || [4, 4]);
                    
                    ctx.beginPath();
                    ctx.moveTo(left, yPosition);
                    ctx.lineTo(right, yPosition);
                    ctx.stroke();

                    if (!line.label) return;

                    ctx.fillStyle = line.color;
                    ctx.font = 'bold 10px Inter';
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'bottom';
                    ctx.fillText(line.label, left, yPosition - 4);
                });
                ctx.restore();
            }
        };

        Chart.register(targetLinesPlugin);
        if (typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);

        const STORE_CONFIG = {
            'MI PLACE KASSOUF':   { color: '#F97316', borderColor: '#EA580C' },
            'MI PLACE XV':        { color: '#334155', borderColor: '#0F172A' },
            'MI PLACE DOM PEDRO': { color: '#3B82F6', borderColor: '#2563EB' },
            'MI PLACE REALME':    { color: '#EAB308', borderColor: '#CA8A04' },
            'MI PLACE PREMIUM':   { color: '#A855F7', borderColor: '#7C3AED' }
        };
        const allStoreNames = Object.keys(STORE_CONFIG);

        const getFormattedDate = (dateStr) => {
            if (!dateStr) return '-';
            const parts = dateStr.split('-');
            if (parts.length !== 3) return '-';
            const date = new Date(parts[0], parts[1] - 1, parts[2]);
            if (isNaN(date.getTime())) return '-';
            const month = date.toLocaleString('pt-BR', { month: 'short' }).replace('.', '');
            const year = date.getFullYear().toString().slice(-2);
            return `${month.charAt(0).toUpperCase() + month.slice(1)}/${year}`;
        };

        const formatNumber = (num, decimals = 0) => {
            if (num === null || isNaN(num)) return '-';
            return new Intl.NumberFormat('pt-BR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(num);
        };

        const updateSummaryMetrics = (data) => {
            let totalSales = 0;
            const numMonths = data.length;
            data.forEach(row => {
                allStoreNames.forEach(store => {
                    const sales = parseFloat(row[store]);
                    if (!isNaN(sales)) totalSales += sales;
                });
            });
            const averageSales = numMonths > 0 ? totalSales / numMonths : 0;
            document.getElementById('totalSales').textContent = formatNumber(totalSales);
            document.getElementById('averageSales').textContent = formatNumber(averageSales, 1);
        };
        
        const handleHoverEffect = (activeElements, chart) => {
            if (!chart) return;
            const isHovering = activeElements.length > 0;
            const activeIndex = isHovering ? activeElements[0].datasetIndex : -1;
            const greyColor = '#cbd5e1';
            
            chart.data.datasets.forEach((dataset, idx) => {
                dataset.datalabels = dataset.datalabels || {};
                if (isHovering) {
                    if (idx === activeIndex) {
                        dataset.borderColor = dataset.originalBorderColor;
                        dataset.borderWidth = 4;
                        dataset.pointRadius = 6; 
                        dataset.pointBorderColor = dataset.originalBorderColor; 
                        dataset.pointBackgroundColor = '#ffffff';
                        dataset.pointHoverRadius = 8;
                        dataset.pointHoverBorderColor = dataset.originalBorderColor;
                        dataset.datalabels.display = 'auto';
                        dataset.order = 1; 
                    } else {
                        dataset.borderColor = greyColor;
                        dataset.borderWidth = 2;
                        dataset.pointRadius = 4;
                        dataset.pointBorderColor = greyColor;
                        dataset.pointBackgroundColor = '#ffffff';
                        dataset.pointHoverRadius = 4;
                        dataset.pointHoverBorderColor = greyColor;
                        dataset.datalabels.display = false;
                        dataset.order = 10;
                    }
                } else {
                    dataset.borderColor = dataset.originalBorderColor;
                    dataset.borderWidth = 2.5;
                    dataset.pointRadius = 6;
                    dataset.pointBorderColor = dataset.originalBorderColor;
                    dataset.pointBackgroundColor = '#ffffff';
                    dataset.pointHoverRadius = 8;
                    dataset.pointHoverBorderColor = dataset.originalBorderColor;
                    dataset.datalabels.display = 'auto';
                    dataset.order = 0;
                }
            });
            chart.update(); 
        };

        const renderChart = () => {
            if (!allValidData.length || !chartLabels.length) return;

            const datasets = allStoreNames.map(store => {
                const config = STORE_CONFIG[store];
                return {
                    label: store.replace('MI PLACE ', ''),
                    data: allValidData.map(row => {
                        const val = parseFloat(row[store]);
                        return isNaN(val) ? null : val;
                    }),
                    originalBorderColor: config.borderColor, 
                    originalBackgroundColor: config.color,
                    borderColor: config.borderColor,
                    backgroundColor: config.color,
                    tension: 0.35,
                    fill: false,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    hitRadius: 30,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: config.borderColor,
                    pointBorderWidth: 2,
                    borderWidth: 2.5,
                    datalabels: { display: 'auto' }
                };
            });
            
            const ctx = document.getElementById('salesChart').getContext('2d');
            if (salesChartInstance) salesChartInstance.destroy();

            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = '#64748b';

            salesChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: chartLabels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        intersect: true,
                        axis: 'xy'
                    },
                    onClick: (event, elements, chart) => {
                        if (!elements.length) return;
                        const element = elements[0];
                        const datasetIndex = element.datasetIndex;
                        const index = element.index;
                        const dataset = chart.data.datasets[datasetIndex];
                        if (dataset.data[index] !== null) {
                            openModal(dataset.label, chart.data.labels[index], dataset.data[index], dataset.originalBackgroundColor);
                        }
                    },
                    onHover: (event, activeElements, chart) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                        handleHoverEffect(activeElements, chart);
                    },
                    layout: { padding: { top: 20, right: 30, left: 10, bottom: 0 } },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            onHover: (event, legendItem, legend) => {
                                event.native.target.style.cursor = 'pointer';
                                handleHoverEffect([{ datasetIndex: legendItem.datasetIndex }], legend.chart);
                            },
                            onLeave: (event, legendItem, legend) => {
                                event.native.target.style.cursor = 'default';
                                handleHoverEffect([], legend.chart);
                            },
                            labels: {
                                usePointStyle: true,
                                boxWidth: 8,
                                padding: 20,
                                font: { size: 11, weight: 500 },
                                generateLabels: (chart) => chart.data.datasets.map((dataset, i) => ({
                                    text: dataset.label,
                                    fillStyle: dataset.originalBackgroundColor,
                                    strokeStyle: dataset.originalBorderColor,
                                    lineWidth: 2,
                                    hidden: !chart.isDatasetVisible(i),
                                    index: i,
                                    datasetIndex: i,
                                    pointStyle: 'circle'
                                }))
                            }
                        },
                        tooltip: {
                            backgroundColor: '#ffffff',
                            titleColor: '#1e293b',
                            bodyColor: '#475569',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 12,
                            boxPadding: 6,
                            usePointStyle: true,
                            callbacks: {
                                label: (context) => {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += formatNumber(context.parsed.y);
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            align: 'top',
                            anchor: 'end',
                            offset: 4,
                            color: (ctx) => ctx.dataset.borderColor,
                            font: { weight: 'bold', size: 9 },
                            formatter: (val) => val !== null ? Math.round(val) : '',
                            display: (context) => context.dataset.datalabels?.display ?? 'auto'
                        },
                        targetLines: {
                            lines: [
                                { value: 135, label: '', color: '#0d9488', dash: [4, 4], width: 1.5 },
                                { value: 65, label: '', color: '#65a30d', dash: [4, 4], width: 1.5 } 
                            ]
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 11 }, color: '#64748b' }, border: { display: false } },
                        y: {
                            beginAtZero: true,
                            max: 300,
                            border: { display: false },
                            grid: { color: '#f1f5f9', borderDash: [4, 4], tickLength: 0 },
                            ticks: { stepSize: 50, padding: 10, font: { size: 11 }, color: '#94a3b8' }
                        }
                    }
                }
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const chartContainer = document.getElementById('chartContainer');
            const errorMessage = document.getElementById('errorMessage');

            try {
                const csvData = `MES,MI PLACE KASSOUF,MI PLACE XV,MI PLACE DOM PEDRO,MI PLACE REALME,MI PLACE PREMIUM
2024-07-01,107,104,,57,
2024-08-01,113,90,132,57,
2024-09-01,107,65,155,61,
2024-10-01,106,63,139,39,
2024-11-01,98,89,176,47,
2024-12-01,129,62,242,60,
2025-01-01,115,68,271,90,23
2025-02-01,58,66,162,67,53,
2025-03-01,36,47,115,39,38,
2025-04-01,58,67,140,81,58,
2025-05-01,42,48,136,59,55,
2025-06-01,72,83,175,87,85,
2025-07-01,65,77,137,54,66,
2025-08-01,65,49,117,68,65,
2025-09-01,67,47,110,52,67,
2025-10-01,46,43,136,74,70,
2025-11-01,65,57,114,78,67,
2025-12-01,65,56,152,81,66,
2026-01-01,46,56,151,55,67
2026-02-01,66,35,118,55,41`;

                const lines = csvData.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim()); 
                const parsedData = lines.slice(1).map(line => {
                    const values = line.split(',').map(v => v.trim());
                    return headers.reduce((acc, h, i) => (acc[h] = values[i] || null, acc), {});
                });

                allValidData = parsedData.filter(row => row.MES); 
                chartLabels = allValidData.map(row => getFormattedDate(row.MES));
                updateSummaryMetrics(allValidData);
                renderChart();
                loadingIndicator.classList.add('hidden');
                chartContainer.classList.remove('hidden');
            } catch (error) {
                loadingIndicator.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                document.getElementById('errorText').textContent = error.message;
            }
        });
    </script>
</body>
</html>