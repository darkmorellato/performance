<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance de Vendas por Loja</title>
    <!-- Inclui o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inclui a biblioteca Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Inclui o plugin Datalabels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- Fonte Inter do Google Fonts para garantir renderização correta -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f1f5f9; /* Slate 100 - Fundo corporativo claro */
        }
        .chart-container {
            position: relative;
            height: 650px; /* Altura aumentada para expandir o campo de visão */
            width: 100%;
        }
        /* Loader minimalista */
        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid #e2e8f0;
            border-bottom-color: #3b82f6;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-slate-800 antialiased p-4 md:p-8">

    <!-- Header Principal -->
    <div class="max-w-7xl mx-auto mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-slate-900 tracking-tight">
                Dashboard de Vendas
            </h1>
            <p class="text-slate-500 text-sm mt-1">
                Rede Mi Place • Acompanhamento Mensal
            </p>
        </div>
        <div class="mt-4 md:mt-0">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-white text-slate-600 border border-slate-200 shadow-sm">
                <span class="w-2 h-2 rounded-full bg-emerald-500 mr-2"></span>
                Atualizado em tempo real
            </span>
        </div>
    </div>

    <!-- Container Principal (Card Branco) -->
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        
        <!-- KPIs / Cards de Resumo -->
        <div class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-100 border-b border-slate-100">
            <!-- Card 1 -->
            <div class="p-6 flex items-start space-x-4">
                <div class="p-3 rounded-lg bg-blue-50 text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">Total de Vendas Acumulado</p>
                    <p id="totalSales" class="text-3xl font-bold text-slate-900 mt-1">--</p>
                    <p class="text-xs text-slate-400 mt-1">Período completo</p>
                </div>
            </div>

            <!-- Card 2 -->
            <div class="p-6 flex items-start space-x-4">
                <div class="p-3 rounded-lg bg-emerald-50 text-emerald-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">Média Mensal da Rede</p>
                    <p id="averageSales" class="text-3xl font-bold text-slate-900 mt-1">--</p>
                    <p class="text-xs text-slate-400 mt-1">Vendas / Mês</p>
                </div>
            </div>
        </div>

        <!-- Área do Gráfico -->
        <div class="p-6 md:p-8">
            <!-- Loading -->
            <div id="loadingIndicator" class="flex flex-col justify-center items-center h-80">
                <span class="loader mb-4"></span>
                <p class="text-slate-500 text-sm font-medium">Processando dados...</p>
            </div>

            <!-- Gráfico -->
            <div id="chartContainer" class="chart-container hidden">
                <canvas id="salesChart"></canvas>
            </div>

            <!-- Erro -->
            <div id="errorMessage" class="hidden p-4 mb-4 text-sm text-red-700 bg-red-50 rounded-lg border border-red-200" role="alert">
                <span class="font-medium">Erro ao carregar dados:</span> <span id="errorText"></span>
            </div>
        </div>
        
        <!-- Footer do Card -->
        <div class="bg-slate-50 px-6 py-4 border-t border-slate-200 flex justify-between items-center text-xs text-slate-500">
            <span>Dados de performance interna</span>
            <span>Mi Place Analytics</span>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // Variáveis globais
        let salesChartInstance = null;
        let allValidData = []; 
        let chartLabels = [];

        // --- PLUGIN: LINHAS DE META (Estilo Refinado) ---
        const targetLinesPlugin = {
            id: 'targetLines',
            beforeDraw: (chart) => {
                const { ctx, chartArea: { top, bottom, left, right }, scales: { y } } = chart;
                const targetLines = chart.options.plugins.targetLines?.lines || [];

                if (targetLines.length === 0) return;

                ctx.save();
                targetLines.forEach(line => {
                    const yPosition = y.getPixelForValue(line.value);

                    // Linha
                    ctx.strokeStyle = line.color || '#94a3b8';
                    ctx.lineWidth = line.width || 1;
                    ctx.setLineDash(line.dash || [4, 4]);
                    
                    ctx.beginPath();
                    ctx.moveTo(left, yPosition);
                    ctx.lineTo(right, yPosition);
                    ctx.stroke();

                    // Se não houver texto definido, não desenha nada além da linha
                    if (!line.label) return;

                    // Label (Tag na esquerda)
                    ctx.fillStyle = line.labelBg || line.color;
                    ctx.font = 'bold 10px Inter';
                    const text = line.label;
                    
                    ctx.fillStyle = line.color;
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'bottom';
                    ctx.fillText(text, left, yPosition - 4);
                });
                ctx.restore();
            }
        };

        Chart.register(targetLinesPlugin);
        if (typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);

        // --- CONFIGURAÇÃO DE CORES (Paleta Profissional) ---
        // Cores ajustadas para serem menos saturadas e mais elegantes
        const STORE_CONFIG = {
            'MI PLACE KASSOUF':   { color: '#F97316', borderColor: '#EA580C' }, // Orange-500/600
            'MI PLACE XV':        { color: '#334155', borderColor: '#0F172A' }, // Slate-700/900 (Preto Suave)
            'MI PLACE DOM PEDRO': { color: '#3B82F6', borderColor: '#2563EB' }, // Blue-500/600
            'MI PLACE REALME':    { color: '#EAB308', borderColor: '#CA8A04' }, // Yellow-500/Darker
            'MI PLACE PREMIUM':   { color: '#A855F7', borderColor: '#7C3AED' }  // Purple-500/600
        };
        const allStoreNames = Object.keys(STORE_CONFIG);

        // Formatadores
        const getFormattedDate = (dateStr) => {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return '-';
            const month = date.toLocaleString('pt-BR', { month: 'short' }).replace('.', '');
            const year = date.getFullYear().toString().slice(-2);
            return `${month.charAt(0).toUpperCase() + month.slice(1)}/${year}`;
        };

        const formatNumber = (num, decimals = 0) => {
            if (num === null || isNaN(num)) return '-';
            return new Intl.NumberFormat('pt-BR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(num);
        };

        // Lógica de Negócio
        const updateSummaryMetrics = (data) => {
            let totalSales = 0;
            const numMonths = data.length;

            data.forEach(row => {
                allStoreNames.forEach(store => {
                    const sales = parseFloat(row[store]);
                    if (!isNaN(sales)) totalSales += sales;
                });
            });

            const averageSales = numMonths > 0 ? totalSales / numMonths : 0;
            
            // Animação simples de contagem (opcional, aqui direto)
            document.getElementById('totalSales').textContent = formatNumber(totalSales);
            document.getElementById('averageSales').textContent = formatNumber(averageSales, 1);
        };
        
        const renderChart = () => {
            if (!allValidData.length || !chartLabels.length) return;

            const datasets = allStoreNames.map(store => {
                const config = STORE_CONFIG[store];
                return {
                    label: store.replace('MI PLACE ', ''), // Remove prefixo para limpar a legenda
                    data: allValidData.map(row => {
                        const val = parseFloat(row[store]);
                        return isNaN(val) ? null : val;
                    }),
                    borderColor: config.borderColor,
                    backgroundColor: config.color,
                    tension: 0.35, // Curva um pouco mais suave
                    fill: false,
                    pointRadius: 6,
                    pointHoverRadius: 9,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: config.borderColor,
                    pointBorderWidth: 2,
                    borderWidth: 2.5,
                };
            });
            
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            if (salesChartInstance) {
                salesChartInstance.destroy();
            }

            // Defaults globais do Chart.js para fonte
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = '#64748b';

            salesChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: chartLabels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    layout: {
                        padding: { top: 20, right: 30, left: 10, bottom: 0 }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 8,
                                padding: 20,
                                font: { size: 11, weight: 500 },
                                color: '#475569'
                            }
                        },
                        tooltip: {
                            backgroundColor: '#ffffff',
                            titleColor: '#1e293b',
                            bodyColor: '#475569',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 12,
                            boxPadding: 6,
                            usePointStyle: true,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += formatNumber(context.parsed.y);
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            align: 'top',
                            anchor: 'end',
                            offset: 4,
                            color: function(ctx) { return ctx.dataset.borderColor },
                            font: { weight: 'bold', size: 9 },
                            formatter: (val) => val !== null ? Math.round(val) : '',
                            display: function(context) {
                                return 'auto'; 
                            }
                        },
                        targetLines: {
                            // Textos removidos (label: '')
                            lines: [
                                { value: 135, label: '', color: '#0d9488', dash: [4, 4], width: 1.5 }, // Teal-600
                                { value: 65, label: '', color: '#65a30d', dash: [4, 4], width: 1.5 }    // Lime-600
                            ]
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false }, // Remove grid vertical
                            ticks: { font: { size: 11 }, color: '#64748b' },
                            border: { display: false }
                        },
                        y: {
                            beginAtZero: true,
                            max: 300,
                            border: { display: false }, // Remove linha do eixo Y
                            grid: {
                                color: '#f1f5f9', // Linhas horizontais muito sutis
                                borderDash: [4, 4],
                                tickLength: 0
                            },
                            ticks: {
                                stepSize: 50, // Menos poluição nos números do eixo Y
                                padding: 10,
                                font: { size: 11 },
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const chartContainer = document.getElementById('chartContainer');
            const errorMessage = document.getElementById('errorMessage');

            try {
                // CSV DATA (Incluindo a correção para DEZ/25)
                const csvData = `MES,MI PLACE KASSOUF,MI PLACE XV,MI PLACE DOM PEDRO,MI PLACE REALME,MI PLACE PREMIUM
2024-07-01,107,104,,57,
2024-08-01,113,90,132,57,
2024-09-01,107,65,155,61,
2024-10-01,106,63,139,39,
2024-11-01,98,89,176,47,
2024-12-01,129,62,242,60,
2025-01-01,115,68,271,90,23
2025-02-01,58,66,162,67,53,
2025-03-01,36,47,115,39,38,
2025-04-01,58,67,140,81,58,
2025-05-01,42,48,136,59,55,
2025-06-01,72,83,175,87,85,
2025-07-01,65,77,137,54,66,
2025-08-01,65,49,117,68,65,
2025-09-01,67,47,110,52,67,
2025-10-01,46,43,136,74,70,
2025-11-01,65,57,114,78,67,
2025-12-01,65,56,152,81,66,
2026-01-01,46,56,151,55,67`;

                // Parser CSV Simplificado
                const lines = csvData.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim()); 
                
                const parsedData = lines.slice(1).map(line => {
                    const values = line.split(',').map(v => v.trim());
                    return headers.reduce((acc, header, index) => {
                        const val = values[index];
                        acc[header] = (val === '' || val === undefined) ? null : val;
                        return acc;
                    }, {});
                });

                allValidData = parsedData.filter(row => row.MES); 
                chartLabels = allValidData.map(row => getFormattedDate(row.MES));

                // Atualizar UI
                updateSummaryMetrics(allValidData);
                renderChart();

                loadingIndicator.classList.add('hidden');
                chartContainer.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                loadingIndicator.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                document.getElementById('errorText').textContent = error.message;
            }
        });
    </script>
</body>
</html>